#!/bin/bash

#
# Sets up and starts PostgreSQL with the requested configuration
#
set -e

# Use the same environment as during build
. /etc/environment

# Set up PostgreSQL directories
mkdir -p $PG_DATA $PG_RUN
chown -R ${PG_USER}: $PG_DATA $PG_RUN

# Initialize PostgreSQL if necessary
if [ ! -f $PG_DATA/PG_VERSION ]; then
    echo 'Initializing PostgreSQL ...'

    # Initialize PostgreSQL
    PWFILE=$(mktemp -u)
    trap "rm -f $PWFILE" EXIT
    echo "$T3_DB_ROOT_PW" >$PWFILE
    su-exec $PG_USER initdb --pgdata=$PG_DATA --auth=md5 --pwfile=$PWFILE

    # Create the TYPO3 database unless it is named 'postgres'
    test "$T3_DB_NAME" = postgres || \
        echo "CREATE DATABASE $T3_DB_NAME;" | \
        su-exec $PG_USER postgres --single -D $PG_DATA -j >/dev/null

    # Set the password for the TYPO3 user and grant superuser privileges
    ACTION=CREATE
    test "$T3_DB_USER" = postgres && ACTION=ALTER

    echo "$ACTION USER $T3_DB_USER WITH SUPERUSER PASSWORD '$T3_DB_PW';" | \
        su-exec $PG_USER postgres --single -D $PG_DATA -j >/dev/null

    # Allow external IPv4 and IPv6 connections
    cat << EOF >>$PG_DATA/pg_hba.conf

host  all  all  0.0.0.0/0  md5
host  all  all  ::0/0      md5
EOF

fi

# Start PostgreSQL
echo $'\nStarting PostgreSQL server ...'
su-exec $PG_USER postgres -D $PG_DATA -c 'listen_addresses=*' &
