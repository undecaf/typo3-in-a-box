#!/bin/bash

#
# Sets up and starts MariaDB with the requested configuration
#
set -e

# Use the same environment as during build
. /etc/environment

# Set up MariaDB directories
mkdir -p $MYSQL_DATA $MYSQL_RUN
chown -R ${MYSQL_USER}: $MYSQL_DATA $MYSQL_RUN

# Initialize MariaDB if necessary
if [ ! -d $MYSQL_DATA/mysql ]; then
    echo 'Initializing MariaDB ...'

    # Initialize MariaDB
    mysql_install_db --user=mysql --ldata=$MYSQL_DATA

    # Create the TYPO3 database and the users
    SQLFILE=$(mktemp -u)
    trap "rm -f $SQLFILE" EXIT

    cat <<EOF >$SQLFILE
USE mysql;
FLUSH PRIVILEGES;
GRANT ALL ON *.* TO 'root'@'%' identified by '$T3_DB_ROOT_PW' WITH GRANT OPTION ;
GRANT ALL ON *.* TO 'root'@'localhost' identified by '$T3_DB_ROOT_PW' WITH GRANT OPTION;
SET PASSWORD FOR 'root'@'localhost'=PASSWORD('$T3_DB_ROOT_PW');
DROP DATABASE IF EXISTS test;
FLUSH PRIVILEGES;
CREATE DATABASE IF NOT EXISTS \`$T3_DB_NAME\` CHARACTER SET utf8 COLLATE utf8_general_ci;
GRANT ALL ON \`$T3_DB_NAME\`.* TO '$T3_DB_USER'@'%' IDENTIFIED BY '$T3_DB_PW';
GRANT ALL ON \`$T3_DB_NAME\`.* TO '$T3_DB_USER'@'localhost' IDENTIFIED BY '$T3_DB_PW';
EOF

    mysqld --datadir=$MYSQL_DATA --user=mysql --bootstrap --verbose=0 --skip-networking=0 <$SQLFILE
fi

# Start MariaDB
echo $'\nStarting MariaDB server ...'
mysqld --datadir=$MYSQL_DATA --user=mysql --console --skip-networking=0 &
